<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
@authors: Tamas Kohegyi
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>Wilma Configuration and Setup</title>

    <link rel="stylesheet" href="../static/elstyle.css" type="text/css"/>
    <link rel="stylesheet" href="../static/pygments.css" type="text/css"/>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <link id="favicon" rel="shortcut icon" type="image/png" href="../static/icon-wilma.png" />
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
    <meta name="HandheldFriendly" content="true" />
    <meta name="apple-mobile-web-app-capable" content="YES" />
    <meta name="author" content="Tamas Kohegyi" />
    <meta name="Description" content="Wilma is Service Virtualization tool, a combined http/https Transparent Proxy and Service Stub" />
    <meta name="Keywords" content="test automation, proxy, stub, wilma, microservices, service virtualization" />
</head>
<body>

<div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="body">

                <div class="section" id="wilma-open-source">
                    <h1>Configuration and Setup</h1>
                </div>

                <h2>Configuring Wilma</h2>

                <p>To <b>run Wilma</b>, it should be configured first in <code>wilma.conf.properties.</code>
                </p>

                <p>This configuration file must contain the following property entries (the values here are the default
                    ones):</p>
<pre>
############################################################################
# Copyright 2013-2016 EPAM Systems
#
# This file is part of Wilma.
#
# Wilma is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Wilma is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Wilma.  If not, see <http://www.gnu.org/licenses/>.
############################################################################

# the port used by the proxy
proxy.port=9092

# internal jetty port on which web application is deployed
internal.wilma.port=1234

#the size of the request buffer used by the web application in bytes
internal.wilma.request.buffer.size=81920
#the size of the response buffer used by the web application in bytes
internal.wilma.response.buffer.size=204800

# host used to communicate with the indexing application via an activemq broker, default is localhost
jms.queue.host=

# port used to communicate with the indexing application via an activemq broker
jms.queue.port=16161

# the value of the request time out in milliseconds
proxy.request.timeout=20000

# enable/disable response volatility (changing the proxy response on-the-fly), default: disable
proxy.response.volatile=false

# maintainer is executed periodically. Time period can be given with cron expression.
log.maintainer.cron=0 0/30 * * * *

# maintainer method can be one of the following: timelimit | filelimit
log.maintainer.method=timelimit

# limit on number of files to keep
log.maintainer.file.limit=10

# files older than this value are deleted if timelimit method is switched on (can be xD days or xH hours - e.g.: 12H, 2D)
log.maintainer.time.limit=1H

# target folder of the request, response log files
log.folder=messages

# guard period of the overload safeguard in seconds. 0 means that the safeguard is inactive, otherwise the time period can be given with cron expressions (e.g.: 0/3 * * * * *).
safeguard.guardperiod=0/3 * * * * *

# when the ActiveMQ queue size exceeds this limit, the FastInfoset decompression is turned off
safeguard.responseFIdecoder.OFFlimit=1200

# when the ActiveMQ queue size drops below this limit, the FastInfoset decompression is turned on
safeguard.responseFIdecoder.ONlimit=800

# when the ActiveMQ queue size exceeds this limit, response logging is turned off completely
safeguard.responseMessageWriter.OFFlimit=1500

# when the ActiveMQ queue size  drops below this limit, response logging is turned on again
safeguard.responseMessageWriter.ONlimit=1000

# turns message logging on/off when Wilma starts
message.logging=on

# should Wilma Message ID be added to the message request headers or not
message.marking=off

# Relative folder path of the stub descriptor JSON configuration files from project root.
stub.descriptors.path=

# Extension pattern of the stub descriptor JSON configuration files (it could be a specific file or *.json)
stub.descriptors.pattern=stubConfig.json

# Relative folder path of the cached stub descriptor JSON configuration files from project root.
stub.descriptors.cache.path=config/cache/stub_descriptors

# Max depth of the stub configuration dialog descriptor elements (condition-set-invoker, template-formatter-set-invoker) child's subtree. This is necessary because of recursive self referring.
stub.descriptor.max.depth=20

# Relative path of the stub template files folder from project root.
stub.template.path=config/templates

# Relative path of the stub condition checker classes folder from project root.
stub.condition.checker.path=config/condition-checkers

# Relative path of the stub template formatter classes folder from project root.
stub.template.formatter.path=config/formatters

# Relative path of the stub interceptor classes folder from project root.
stub.interceptor.path=config/interceptors

# Relative path of the jar and its classes folder from project root.
stub.jar.path=config/jar

# Relative path of the sequence handler classes folder from project root.
stub.sequence.handler.path=config/sequencehandlers

# switch between the following operation modes: proxy mode, stub mode and normal mode (valid inputs are: stub, proxy, wilma)
switch=wilma

# Interceptors - switch between using or not using Interceptors at all (config still will be loaded)
interceptor=off

# Block localhost usage - switch between forwarding messages addressed to localhost (mode: off) or denying them (mode: on)
block.localhost.usage=off

# Sequence Handling - Switch between enabling/disabling the sequence handling functionality
sequence.handling.state=off

# Defines the interval of waiting for the sequence responses (in milliseconds)
sequence.response.wait.interval=500

# the default timeout of sequences given in milliseconds
sequence.timeout=9000

# the url of readme and the text of the readme url
wilma.readme.url=http://epam.github.io/Wilma/
wilma.readme.text=Wilma Documentation

# prefix text for Wilma instance
wilma.instance.prefix=

#Relative path to admin hosts file from project root.
#The admin hosts file should contain one hostname or IP per line.
wilma.admin.hosts.file=

# sequence cleaning is executed periodically. Time period can be given with cron expression.
sequence.cleanup.cron=0 0/03 * * * *

# The maximum value of displayed messages.
message.log.UI.maxsize=500
</pre>
                <p>There are two reserved ports which aren't configurable, 1099 and 2015. Pay attention to not use
                    them.</p>

                <p>The communication among the modules and between Wilma and Wilma Message Search goes through ActiveMQQueues.
                    The default port is 1099 to connect to that service which monitors the LoggerQueue and ResponseQueue
                    in Wilma. Port 2015 is used by this service in the Wilma Message Search.</p>

                <p>The hardcoded values are in these files:</p>
                <ul>
                    <li>com.epam.wilma.safeguard.monitor.JmsQueueMonitorTask</li>
                    <li>com.epam.message.search.web.controller.LoadInformationController</li>
                    <li>/wilma-message-search-lucene/src/main/resources/conf/spring/lucene-application-context.xml</li>
                </ul>


                <h2>Running Wilma</h2>

                <p>After the configuration is done, you can run Wilma by entering the following command:</p>
                <code><pre>
java [-Dlogger=DEV]
     [-Xmx4096m]
     [-Djavax.net.ssl.keyStore=jks_holding_client_certificate]
     [-Djavax.net.ssl.keyStorePassword=password_of_jks]
     [-Dcom.sun.management.jmxremote.port=jmx_port -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false]
     -jar wilma-&lt;version&gt;.jar wilma.conf.properties
                </pre></code>
                <ul>
                    <li>The VM argument <code>-Dlogger=DEV</code> is optional and can be used to log detailed more
                        information on the console.
                    </li>
                    <li>The VM argument <code>-Xmx</code> specifies the max heap space that Wilma can use.
                        It is recommended to set it based on the measured memory usage that is in connection to the traffic load that goes through Wilma.
                        It is recommended to use 4G as starting point, and increase/decrease it as the actual use requires.
                    </li>
                    <li>The VM argument <code>-Djavax.net.ssl.keyStore</code> specifies the Java Key Store file that
                        holds the client certificates that are needed for two-way SSL. 
                    </li>
                    <li>The VM argument <code>-Djavax.net.ssl.keyStorePassword </code>is the password of the Java Key
                        Store in the previous argument.
                    </li>
                    <li>The VM arguments <code>-Dcom.sun.management.jmxremote.XXX </code>are used when you would like to attach to Wilma via Java JMX Console, for monitorig purposes.
                    </li>
                </ul>
                <p>Wilma application logs are normally stored in the <strong>/log/app</strong> folder.</p>

                <p>The command above requires that the properties file is in the same folder as the JAR. If you place
                    the configuration file to a different location, you should run the JAR by specifying the full path
                    of the configuration file.
                <p>If the tool starts successfully, you should see something similar on the console:</p>
                <code><pre>
11:35:41 - Timelimit method is used to maintain log files with parameters: timelimit: 1H
11:35:41 - Wilma-v1.3.111
Copyright 2013-2015 EPAM Systems - GNU GPL-V3.0 License
Used proxy port: 9092
Wilma UI is available via URL: http://localhost:1234/index/
Application logs are stored in 'D:\wilma\log\app' folder.
Request-response pairs are stored in 'D:\wilma\messages' folder.
                    </pre></code>
                <h2>Loading Stub Configs</h2>
                <p>Details about how the Stub is configured, can be found <a href="https://github.com/epam/Wilma/wiki/Stub-Configuration">here...</a>.</p>
                <p>At start up Wilma checks the cache folder (see parameter:
                    <strong>stub.descriptors.cache.path</strong>) how many file looks like *_stubConfig.json where *
                    means &gt;0 integer value. If there is at least one file with this name pattern, Wilma will load
                    these files in order. If there is not any such file, then Wilma try to load the stub configuration
                    in the following steps.</p>
                <ol>
                    <li>Checks whether <strong>stub.descriptors.pattern</strong> contains a specific file name without
                        any *. If it contains, then Wilma looks for this file in that folder which is given <strong>stub.descriptors.path</strong> property. <br/>If
                        the given file does not exist in that folder, Wilma will shut down with an error message.
                    </li>
                    <li>If <strong>stub.descriptors.pattern</strong> contains a *, Wilma looks for those files in
                        the <strong>stub.descriptors.path</strong> folder which matched with the given pattern. <br/>This
                        pattern must be like *something.json, *.json ...!<br/>Note: "some*thing.json" is a WRONG pattern,
                        Wilma is not able to work with such pattern!
                    </li>
                </ol>
                <h2>Using Wilma</h2>
                <p>After Wilma starts, you can use it as an HTTP and HTTPS proxy that logs every request and response
                    that goes through it.</p>

                <h2>Configuring a Java client application to use Wilma as a proxy/stub</h2>

                <p>If you want to use Wilma as a proxy for a Java client application, you must configure it to go through
                    Wilma.</p>

                <p>The most simple way to do this is by adding a few<strong> VM arguments </strong>to the run
                    configuration:</p>
                <code><pre>
-Dhttp.proxyHost=[wilma-host]
-Dhttp.proxyPort=[wilma-port]
-Dhttps.proxyHost=[wilma-host]
-Dhttps.proxyPort=[wilma-port]
-Djavax.net.ssl.trustStore=[path/to/wilma.jks]
-Djavax.net.ssl.trustStorePassword=vvilma</pre></code>
                <ul>
                    <li>
                        <code>[wilma-url]</code> is the URL of the server where Wilma is running.
                    </li>
                    <li>
                        <code>[wilma-port]</code> is the port that is configured in wilma.conf.properties (<code>proxy.port</code>,
                        default is <strong>9092</strong>)
                    </li>
                    <li>
                        <code>[path/to/wilma.jks] </code>the path to the<code> wilma.jks </code>file (it can be found
                        in <code>wilma.zip</code> under <strong>certificate/wilma.jks</strong>)
                    </li>
                </ul>
                <p>The first 4 arguments mean that the application should use a proxy on the given host and port (both for HTTP and for HTTPS connections), the
                    third argument specifies a Java Key Store (JKS) file that contains the certificates trusted by the
                    client application. Depending of the HTTP/S client used by your application, other parameters might also need to be set.</p>

                <p>Wilma uses an unsigned certificate contained by <code>wilma.jks</code> to be able to proxy HTTPS
                    connections too<code>.</code>
                </p>

                <p>The client Java application has to be configured to accept this certificate to be able to access a
                    host that uses SSL.</p>

                <h2>Configuring "run" task of Gradle to use Wilma as a proxy/stub</h2>
                <p>If you want to use Wilma as a proxy/stub for a Java application executed via `run` task of `application` Gradle plugin, just specify the same arguments as mentioned above in `applicationDefaultJvmArgs` parameter.
                    See example below (for http protocol only):</p>
                <code><pre>
...
applicationDefaultJvmArgs = ["-Dhttp.proxyHost=127.0.0.1", "-Dhttp.proxyPort=9092"]
...</pre></code>

                <h2>Using Wilma Message Search</h2>
                <p>Detailed information on how to configure and use <b>Wilma Message Search</b> application can be found <a href="https://github.com/epam/Wilma/wiki/Wilma-Message-Search-Application">here</a>.</p>


                <h2>Further information</h2>

                <ul>
                    <li><a class="reference external" href="feature_list.html">Feature list</a>
                        : All that Wilma can do for you
                    </li>
                    <li><a class="reference external" href="https://github.com/epam/Wilma/wiki/Wilma-Issues-and-Solutions">Project
                        experiences</a> : Solutions from the real-life
                    </li>
                    <li><a class="reference external" href="https://github.com/epam/Wilma/releases">Release
                        Notes</a> : About what was changed and when
                    </li>
                </ul>

            </div>
        </div>
    </div>
    <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
            <a href="#">
                <img class="logo" src="../static/EPAM_LOGO_gray_blue.png" alt="Logo"/>
            </a>
        </p>

            <p/>

            <h3>Table Of Contents</h3>
            <ul>
                <li class="toctree-l1"><a class="reference internal" href="../index.html">Wilma Home page</a></li>
                <li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction to
                    Wilma</a></li>
                <li class="toctree-l1"><a class="reference internal" href="index.html">End-user information</a></li>
                <li class="toctree-l1"><a class="reference internal" href="../developers/index.html">Developer
                    information</a></li>
                <li class="toctree-l1"><a class="reference internal" href="https://github.com/epam/Wilma/releases">Downloads</a></li>
                <li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact Info</a></li>
            </ul>
        </div>
    </div>
    <div class="clearer"></div>
</div>
<div class="footer">
    &copy;2018, EPAM Systems.
</div>


</body>
</html>